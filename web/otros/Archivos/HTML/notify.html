<button id="notif-btn" style="position:fixed;bottom:20px;right:20px;z-index:999;padding:10px 16px;border-radius:20px;border:none;background:rgba(255,255,255,.15);backdrop-filter:blur(8px);color:#fff;cursor:pointer;font-size:.9rem;display:none"></button>

<script>
(function(){
const W='https://TU-WORKER.TU-USUARIO.workers.dev';
const VP='TU_VAPID_PUBLIC_KEY';
const btn=document.getElementById('notif-btn');

if(!('serviceWorker' in navigator)||!('PushManager' in window)){return}
btn.style.display='block';

function b64(b){
const s=String.fromCharCode(...new Uint8Array(b));
return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function u8(s){
const p=atob(s.replace(/-/g,'+').replace(/_/g,'/'));
return Uint8Array.from(p,c=>c.charCodeAt(0));
}

async function gS(){
const sw=await navigator.serviceWorker.ready;
return sw.pushManager.getSubscription();
}

async function upd(){
const s=await gS();
btn.textContent=s?'ðŸ”• Desactivar notificaciones':'ðŸ”” Activar notificaciones';
}

async function sub(){
const sw=await navigator.serviceWorker.ready;
const s=await sw.pushManager.subscribe({
userVisibleOnly:true,
applicationServerKey:u8(VP)
});
const j=s.toJSON();
await fetch(W+'/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(j)});
}

async function unsub(){
const s=await gS();
if(!s)return;
await fetch(W+'/unsubscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({endpoint:s.endpoint})});
await s.unsubscribe();
}

btn.addEventListener('click',async()=>{
btn.disabled=true;
try{
const p=await Notification.requestPermission();
if(p!=='granted'){btn.disabled=false;return}
const s=await gS();
if(s)await unsub();
else await sub();
await upd();
}catch(e){}
btn.disabled=false;
});

upd();

// Fallback polling cada 24h
if(navigator.serviceWorker.controller){
setInterval(()=>{
navigator.serviceWorker.controller.postMessage('CHECK_DJ');
},86400000);
}
})();
</script>
