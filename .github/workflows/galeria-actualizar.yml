name: BOT Galeria + Optimizador + Pages
on:
  push:
    paths:
      - 'web/Dinamico/**'
      - 'web/otros/Archivos/Imagenes/**'
  workflow_dispatch:
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Instalar WebP tools
        run: |
          sudo apt-get update
          sudo apt-get install -y webp python3
      - name: Procesar Imagenes + Generar JSON
        run: |
          python3 << 'EOF'
          import os,json,subprocess,tempfile
          from pathlib import Path
          ST=200*1024
          NT=100*1024
          AT=300*1024
          AN=200*1024
          B1=Path('web/Dinamico')
          B2=Path('web/otros/Archivos/Imagenes')
          def sz(p): return p.stat().st_size
          def rc(cmd): subprocess.run(cmd,stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)
          def ia(p):
            r=subprocess.run(['webpmux','-info',str(p)],capture_output=True,text=True)
            return 'Number of frames: 1' not in r.stdout
          def cs(img):
            tmp=Path(tempfile.gettempdir())/(img.stem+'.webp')
            for q in range(85,10,-5):
              rc(['cwebp','-q',str(q),'-m','6','-size',str(NT),str(img),'-o',str(tmp)])
              if tmp.exists() and sz(tmp)<=NT:
                break
            if tmp.exists():
              final=img.with_suffix('.webp')
              tmp.replace(final)
              if img!=final: img.unlink()
          def cv(img):
            tmp=Path(tempfile.gettempdir())/(img.stem+'.webp')
            rc(['cwebp','-q','100','-m','6',str(img),'-o',str(tmp)])
            if tmp.exists():
              final=img.with_suffix('.webp')
              tmp.replace(final)
              if img!=final: img.unlink()
          def g2w(g,nc=False):
            tmp=Path(tempfile.gettempdir())/(g.stem+'.webp')
            if nc:
              rc(['gif2webp','-q','100','-m','6',str(g),'-o',str(tmp)])
            else:
              for q in range(80,10,-5):
                rc(['gif2webp','-lossy','-q',str(q),'-m','6','-size',str(AN),str(g),'-o',str(tmp)])
                if tmp.exists() and sz(tmp)<=AN:
                  break
            if tmp.exists():
              g.with_suffix('.webp').write_bytes(tmp.read_bytes())
              tmp.unlink()
              g.unlink()
          def ra(w):
            tmp=Path(tempfile.gettempdir())/(w.stem+'_a.webp')
            for q in range(80,10,-5):
              rc(['gif2webp','-lossy','-q',str(q),'-m','6','-size',str(AN),str(w),'-o',str(tmp)])
              if tmp.exists() and sz(tmp)<=AN:
                break
            if tmp.exists():
              tmp.replace(w)
          def proc(base,nc=False):
            if not base.exists(): return
            for img in base.rglob('*'):
              if not img.is_file(): continue
              ext,s=img.suffix.lower(),sz(img)
              if ext=='.gif':
                g2w(img,nc)
              elif ext=='.webp':
                if ia(img):
                  if not nc and s>AT: ra(img)
                else:
                  if nc: cv(img)
                  elif s>ST: cs(img)
              elif ext in {'.jpg','.jpeg','.png'}:
                if nc: cv(img)
                elif s>ST: cs(img)
          proc(B1)
          proc(B2,nc=True)
          EX={'.webp'}
          def bg(base):
            g={}
            for r,d,f in os.walk(base):
              im=sorted(x for x in f if Path(x).suffix.lower() in EX)
              if not im: continue
              rp=os.path.relpath(r,base)
              ps=[os.path.join(r,x).replace(os.sep,'/') for x in im]
              if rp=='.':
                g.setdefault('_root',[]).extend(ps)
              else:
                parts=Path(rp).parts
                if len(parts)==1:
                  g.setdefault(parts[0],[]).extend(ps)
                else:
                  sub=g.setdefault(parts[0],{})
                  sub.setdefault(parts[1],[]).extend(ps)
            return g
          def wj(p,d):
            with open(p,'w',encoding='utf-8') as f:
              json.dump(d,f,separators=(',',':'),ensure_ascii=False)
          if B1.exists():
            g={}
            for fd in B1.iterdir():
              if fd.is_dir():
                r=bg(fd)
                g[fd.name]=r.get('_root',r)
            wj(B1/'data.json',{'galleries':g})
          if B2.exists():
            wj(B2/'data.json',{'galleries':bg(B2)})
          EOF
      - name: Commit cambios
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "Optimización imágenes + JSON"
          git push
      - name: Preparar artifact Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy Pages
        id: deployment
        uses: actions/deploy-pages@v4
