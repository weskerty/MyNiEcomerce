name: BOT Galeria + Optimizador + Pages

on:
  push:
    paths:
      - 'web/Dinamico/**'
      - 'web/otros/Archivos/Imagenes/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar trabajo pendiente
        id: detect
        run: |
          python3 << 'EOF'
          import os
          from pathlib import Path

          ST=200*1024
          AT=300*1024
          B=Path('web/Dinamico')

          def necesita():
            if not B.exists():
              return False
            for f in B.rglob('*'):
              if not f.is_file():
                continue
              ext=f.suffix.lower()
              s=f.stat().st_size
              if ext in {'.jpg','.jpeg','.png'} and s>ST:
                return True
              if ext=='.gif':
                return True
              if ext=='.webp' and s>AT:
                return True
            return False

          with open(os.environ['GITHUB_OUTPUT'],'a') as gh:
            gh.write(f"optimize={'true' if necesita() else 'false'}\n")
          EOF

      - name: Instalar herramientas
        if: steps.detect.outputs.optimize == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y webp

      - name: Procesar Imagenes + Generar JSON
        run: |
          python3 << 'EOF'
          import os,json,subprocess,tempfile
          from pathlib import Path

          ST=200*1024
          NT=100*1024
          AT=300*1024
          AN=200*1024

          B1=Path('web/Dinamico')
          B2=Path('web/otros/Archivos/Imagenes')

          def sz(p): return p.stat().st_size if p.exists() else 0
          def kb(b): return round(b/1024,1)
          def rc(cmd): subprocess.run(cmd,stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)

          def tool_ok(t):
            return subprocess.call(['which',t],stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)==0

          TOOLS=all(tool_ok(t) for t in ['cwebp','gif2webp','img2webp','webpmux'])

          def ia(p):
            if not TOOLS: return False
            r=subprocess.run(['webpmux','-info',str(p)],capture_output=True,text=True)
            if 'Number of frames:' not in r.stdout: return False
            for l in r.stdout.splitlines():
              if 'Number of frames:' in l:
                try: return int(l.split(':')[1].strip())>1
                except: return False
            return False

          def lg(n,s,e): print(f"{n} | {kb(s)}kb → {kb(e)}kb")

          def cs(img):
            if not TOOLS: return
            s=sz(img)
            tmp=Path(tempfile.gettempdir())/(img.stem+'.webp')
            for q in range(85,10,-5):
              rc(['cwebp','-q',str(q),'-m','6','-size',str(NT),str(img),'-o',str(tmp)])
              if tmp.exists() and sz(tmp)<=NT: break
            if tmp.exists():
              final=img.with_suffix('.webp')
              tmp.replace(final)
              if img!=final: img.unlink()
              lg(img.name,s,sz(final))

          def cv(img):
            if not TOOLS: return
            s=sz(img)
            tmp=Path(tempfile.gettempdir())/(img.stem+'.webp')
            rc(['cwebp','-q','100','-m','6',str(img),'-o',str(tmp)])
            if tmp.exists():
              final=img.with_suffix('.webp')
              tmp.replace(final)
              if img!=final: img.unlink()
              lg(img.name,s,sz(final))

          def g2w(g):
            if not TOOLS: return
            s=sz(g)
            tmp=Path(tempfile.gettempdir())/(g.stem+'.webp')
            for q in range(80,10,-5):
              rc(['gif2webp','-lossy','-q',str(q),'-m','6','-size',str(AN),str(g),'-o',str(tmp)])
              if tmp.exists() and sz(tmp)<=AN: break
            if tmp.exists():
              final=g.with_suffix('.webp')
              final.write_bytes(tmp.read_bytes())
              tmp.unlink()
              g.unlink()
              lg(g.name,s,sz(final))

          def proc(base):
            if not base.exists(): return
            for img in base.rglob('*'):
              if not img.is_file(): continue
              ext,s=img.suffix.lower(),sz(img)
              if ext=='.gif':
                g2w(img)
              elif ext in {'.jpg','.jpeg','.png'} and s>ST:
                cs(img)
              elif ext=='.webp' and TOOLS and not ia(img) and s>ST:
                cs(img)

          if TOOLS:
            proc(B1)

          EX={'.webp','.jpg','.jpeg','.png','.gif','.avif','.svg','.bmp','.tiff','.tif','.ico'}

          def bg(base):
            g={}
            for r,d,f in os.walk(base):
              im=sorted(x for x in f if Path(x).suffix.lower() in EX)
              if not im: continue
              rp=os.path.relpath(r,base)
              ps=[os.path.join(r,x).replace(os.sep,'/') for x in im]
              if rp=='.':
                g.setdefault('_root',[]).extend(ps)
              else:
                parts=Path(rp).parts
                if len(parts)==1:
                  g.setdefault(parts[0],[]).extend(ps)
                else:
                  sub=g.setdefault(parts[0],{})
                  sub.setdefault(parts[1],[]).extend(ps)
            return g

          def wj(p,d):
            with open(p,'w',encoding='utf-8') as f:
              json.dump(d,f,separators=(',',':'),ensure_ascii=False)

          if B1.exists():
            g={}
            for fd in B1.iterdir():
              if fd.is_dir():
                r=bg(fd)
                g[fd.name]=r.get('_root',r)
            wj(B1/'data.json',{'galleries':g})

          if B2.exists():
            wj(B2/'data.json',{'galleries':bg(B2)})
          EOF

      - name: Commit cambios
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "Optimización imágenes + JSON"
          git push

      - name: Preparar artifact Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy Pages
        id: deployment
        uses: actions/deploy-pages@v4
